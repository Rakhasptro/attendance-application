<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/rakha/hadirapp/ui/attendance/ScanQrScreen.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/rakha/hadirapp/ui/attendance/ScanQrScreen.kt" />
              <option name="originalContent" value="package com.rakha.hadirapp.ui.attendance&#10;&#10;import android.Manifest&#10;import android.annotation.SuppressLint&#10;import android.app.Activity&#10;import android.content.Intent&#10;import android.content.pm.PackageManager&#10;import android.net.Uri&#10;import android.provider.Settings&#10;import android.util.Log&#10;import androidx.activity.compose.rememberLauncherForActivityResult&#10;import androidx.activity.result.contract.ActivityResultContracts&#10;import androidx.camera.core.*&#10;import androidx.camera.lifecycle.ProcessCameraProvider&#10;import androidx.camera.view.PreviewView&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.material3.Button&#10;import androidx.compose.material3.MaterialTheme&#10;import androidx.compose.material3.Surface&#10;import androidx.compose.material3.Text&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.lifecycle.compose.LocalLifecycleOwner&#10;import androidx.compose.ui.unit.dp&#10;import androidx.compose.ui.viewinterop.AndroidView&#10;import androidx.core.content.ContextCompat&#10;import androidx.lifecycle.Lifecycle&#10;import androidx.lifecycle.LifecycleEventObserver&#10;import androidx.navigation.NavController&#10;import androidx.camera.core.ExperimentalGetImage&#10;import com.google.mlkit.vision.barcode.BarcodeScannerOptions&#10;import com.google.mlkit.vision.barcode.BarcodeScanning&#10;import com.google.mlkit.vision.common.InputImage&#10;import java.util.concurrent.ExecutorService&#10;import java.util.concurrent.Executors&#10;&#10;@SuppressLint(&quot;UnsafeOptInUsageError&quot;, &quot;NewApi&quot;)&#10;@Composable&#10;fun ScanQrScreen(navController: NavController) {&#10;    val context = LocalContext.current&#10;    val activity = context as? Activity&#10;    val lifecycleOwner = LocalLifecycleOwner.current&#10;&#10;    // check current permission state first&#10;    var hasCameraPermission by remember {&#10;        mutableStateOf(&#10;            ContextCompat.checkSelfPermission(context, Manifest.permission.CAMERA) == PackageManager.PERMISSION_GRANTED&#10;        )&#10;    }&#10;&#10;    var detected by remember { mutableStateOf(false) }&#10;    var permissionRequested by remember { mutableStateOf(false) }&#10;    var awaitingPermission by remember { mutableStateOf(false) }&#10;&#10;    val launcher = rememberLauncherForActivityResult(contract = ActivityResultContracts.RequestPermission(), onResult = { granted -&gt;&#10;        hasCameraPermission = granted&#10;        awaitingPermission = false&#10;        permissionRequested = true&#10;    })&#10;&#10;    // Observe lifecycle to refresh permission when returning from settings or permission dialog&#10;    DisposableEffect(lifecycleOwner) {&#10;        val observer = LifecycleEventObserver { _, event -&gt;&#10;            if (event == Lifecycle.Event.ON_RESUME) {&#10;                val nowGranted = ContextCompat.checkSelfPermission(context, Manifest.permission.CAMERA) == PackageManager.PERMISSION_GRANTED&#10;                hasCameraPermission = nowGranted&#10;            }&#10;        }&#10;        lifecycleOwner.lifecycle.addObserver(observer)&#10;        onDispose { lifecycleOwner.lifecycle.removeObserver(observer) }&#10;    }&#10;&#10;    // auto-launch permission request once when screen appears if not yet granted&#10;    LaunchedEffect(Unit) {&#10;        if (!hasCameraPermission &amp;&amp; !permissionRequested &amp;&amp; !awaitingPermission) {&#10;            awaitingPermission = true&#10;            launcher.launch(Manifest.permission.CAMERA)&#10;        }&#10;    }&#10;&#10;    Surface(modifier = Modifier.fillMaxSize()) {&#10;        Box(modifier = Modifier.fillMaxSize()) {&#10;            if (hasCameraPermission) {&#10;                CameraPreviewForScanner(lifecycleOwner = lifecycleOwner, onQrDetected = { sessionId -&gt;&#10;                    if (!detected) {&#10;                        detected = true&#10;                        Log.d(&quot;ScanQrScreen&quot;, &quot;QR detected: $sessionId&quot;)&#10;                        navController.navigate(&quot;selfie_capture/$sessionId&quot;)&#10;                    }&#10;                })&#10;            } else {&#10;                // If we are awaiting the system permission dialog&#10;                if (awaitingPermission) {&#10;                    Column(modifier = Modifier.fillMaxSize(), horizontalAlignment = Alignment.CenterHorizontally, verticalArrangement = Arrangement.Center) {&#10;                        Text(&quot;Requesting camera permission...&quot;)&#10;                    }&#10;                } else if (!permissionRequested) {&#10;                    // never requested yet (rare because we auto-launch), show prompt UI&#10;                    Column(modifier = Modifier.fillMaxSize(), horizontalAlignment = Alignment.CenterHorizontally, verticalArrangement = Arrangement.Center) {&#10;                        Text(&quot;Camera permission is required to scan QR codes&quot;, color = MaterialTheme.colorScheme.error)&#10;                        Spacer(modifier = Modifier.height(12.dp))&#10;                        Button(onClick = {&#10;                            awaitingPermission = true&#10;                            launcher.launch(Manifest.permission.CAMERA)&#10;                        }) {&#10;                            Text(&quot;Request permission&quot;)&#10;                        }&#10;                    }&#10;                } else {&#10;                    // permission was requested and denied&#10;                    val shouldShowRationale = activity?.let { androidx.core.app.ActivityCompat.shouldShowRequestPermissionRationale(it, Manifest.permission.CAMERA) } ?: false&#10;                    Column(modifier = Modifier.fillMaxSize(), horizontalAlignment = Alignment.CenterHorizontally, verticalArrangement = Arrangement.Center) {&#10;                        Text(&quot;Camera permission is required to scan QR codes&quot;, color = MaterialTheme.colorScheme.error)&#10;                        Spacer(modifier = Modifier.height(12.dp))&#10;&#10;                        // Offer to request permission again&#10;                        Button(onClick = {&#10;                            awaitingPermission = true&#10;                            launcher.launch(Manifest.permission.CAMERA)&#10;                        }) {&#10;                            Text(&quot;Request permission&quot;)&#10;                        }&#10;&#10;                        Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                        // Show settings button only when the user already denied and Android will not show the dialog again&#10;                        if (!shouldShowRationale) {&#10;                            Button(onClick = {&#10;                                val intent = Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS).apply {&#10;                                    data = Uri.fromParts(&quot;package&quot;, context.packageName, null)&#10;                                }&#10;                                context.startActivity(intent)&#10;                            }) {&#10;                                Text(&quot;Open app settings&quot;)&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@SuppressLint(&quot;NewApi&quot;)&#10;@ExperimentalGetImage&#10;@Composable&#10;private fun CameraPreviewForScanner(lifecycleOwner: androidx.lifecycle.LifecycleOwner, onQrDetected: (String) -&gt; Unit, lensFacing: Int = CameraSelector.LENS_FACING_BACK) {&#10;    val context = androidx.compose.ui.platform.LocalContext.current&#10;    val previewView = remember { PreviewView(context) }&#10;    val cameraExecutor: ExecutorService = remember { Executors.newSingleThreadExecutor() }&#10;&#10;    // Debounce mechanism to prevent multiple scans&#10;    var lastScanTime by remember { mutableStateOf(0L) }&#10;    val debounceDelay = 2000L // 2 seconds&#10;&#10;    AndroidView(factory = { ctx -&gt;&#10;        val cameraProviderFuture = ProcessCameraProvider.getInstance(ctx)&#10;        cameraProviderFuture.addListener({&#10;            val cameraProvider = cameraProviderFuture.get()&#10;&#10;            val preview = Preview.Builder().build().also { it.setSurfaceProvider(previewView.surfaceProvider) }&#10;&#10;            val selector = CameraSelector.Builder().requireLensFacing(lensFacing).build()&#10;&#10;            // ML Kit barcode scanner&#10;            // Barcode.FORMAT_QR_CODE constant value is 256; using numeric here to avoid unresolved import in analysis environment&#10;            val options = BarcodeScannerOptions.Builder().setBarcodeFormats(256).build()&#10;            val scanner = BarcodeScanning.getClient(options)&#10;&#10;            val analysisUseCase = ImageAnalysis.Builder()&#10;                .setBackpressureStrategy(ImageAnalysis.STRATEGY_KEEP_ONLY_LATEST)&#10;                .build()&#10;&#10;            analysisUseCase.setAnalyzer(cameraExecutor, { imageProxy: ImageProxy -&gt;&#10;                val mediaImage = imageProxy.image&#10;                if (mediaImage != null) {&#10;                    val image = InputImage.fromMediaImage(mediaImage, imageProxy.imageInfo.rotationDegrees)&#10;                    scanner.process(image)&#10;                        .addOnSuccessListener { barcodes -&gt;&#10;                            for (barcode in barcodes) {&#10;                                val raw = barcode.rawValue&#10;                                if (!raw.isNullOrEmpty()) {&#10;                                    // Apply debounce&#10;                                    val now = System.currentTimeMillis()&#10;                                    if (now - lastScanTime &gt; debounceDelay) {&#10;                                        lastScanTime = now&#10;                                        Log.d(&quot;ScanQr&quot;, &quot;QR code detected: $raw&quot;)&#10;                                        onQrDetected(raw)&#10;                                    } else {&#10;                                        Log.d(&quot;ScanQr&quot;, &quot;QR scan debounced, ignoring&quot;)&#10;                                    }&#10;                                    break&#10;                                }&#10;                            }&#10;                        }&#10;                        .addOnFailureListener { e -&gt;&#10;                            Log.e(&quot;ScanQr&quot;, &quot;barcode scan failed&quot;, e)&#10;                        }&#10;                        .addOnCompleteListener {&#10;                            imageProxy.close()&#10;                        }&#10;                } else {&#10;                    imageProxy.close()&#10;                }&#10;            })&#10;&#10;            try {&#10;                cameraProvider.unbindAll()&#10;                cameraProvider.bindToLifecycle(lifecycleOwner, selector, preview, analysisUseCase)&#10;            } catch (exc: Exception) {&#10;                Log.e(&quot;CameraPreview&quot;, &quot;Use case binding failed&quot;, exc)&#10;            }&#10;&#10;        }, ContextCompat.getMainExecutor(ctx))&#10;&#10;        previewView&#10;&#10;    }, modifier = Modifier.fillMaxSize())&#10;}&#10;" />
              <option name="updatedContent" value="package com.rakha.hadirapp.ui.attendance&#10;&#10;import android.Manifest&#10;import android.annotation.SuppressLint&#10;import android.app.Activity&#10;import android.content.Intent&#10;import android.content.pm.PackageManager&#10;import android.net.Uri&#10;import android.provider.Settings&#10;import android.util.Log&#10;import androidx.activity.compose.rememberLauncherForActivityResult&#10;import androidx.activity.result.contract.ActivityResultContracts&#10;import androidx.camera.core.*&#10;import androidx.camera.lifecycle.ProcessCameraProvider&#10;import androidx.camera.view.PreviewView&#10;import androidx.compose.foundation.layout.*&#10;import androidx.compose.material3.Button&#10;import androidx.compose.material3.MaterialTheme&#10;import androidx.compose.material3.Surface&#10;import androidx.compose.material3.Text&#10;import androidx.compose.runtime.*&#10;import androidx.compose.ui.Alignment&#10;import androidx.compose.ui.Modifier&#10;import androidx.compose.ui.platform.LocalContext&#10;import androidx.lifecycle.compose.LocalLifecycleOwner&#10;import androidx.compose.ui.unit.dp&#10;import androidx.compose.ui.viewinterop.AndroidView&#10;import androidx.core.content.ContextCompat&#10;import androidx.lifecycle.Lifecycle&#10;import androidx.lifecycle.LifecycleEventObserver&#10;import androidx.navigation.NavController&#10;import androidx.camera.core.ExperimentalGetImage&#10;import com.google.mlkit.vision.barcode.BarcodeScannerOptions&#10;import com.google.mlkit.vision.barcode.BarcodeScanning&#10;import com.google.mlkit.vision.common.InputImage&#10;import java.util.concurrent.ExecutorService&#10;import java.util.concurrent.Executors&#10;&#10;@SuppressLint(&quot;UnsafeOptInUsageError&quot;, &quot;NewApi&quot;)&#10;@Composable&#10;fun ScanQrScreen(navController: NavController) {&#10;    val context = LocalContext.current&#10;    val activity = context as? Activity&#10;    val lifecycleOwner = LocalLifecycleOwner.current&#10;&#10;    // check current permission state first&#10;    var hasCameraPermission by remember {&#10;        mutableStateOf(&#10;            ContextCompat.checkSelfPermission(context, Manifest.permission.CAMERA) == PackageManager.PERMISSION_GRANTED&#10;        )&#10;    }&#10;&#10;    var detected by remember { mutableStateOf(false) }&#10;    var permissionRequested by remember { mutableStateOf(false) }&#10;    var awaitingPermission by remember { mutableStateOf(false) }&#10;&#10;    val launcher = rememberLauncherForActivityResult(contract = ActivityResultContracts.RequestPermission(), onResult = { granted -&gt;&#10;        hasCameraPermission = granted&#10;        awaitingPermission = false&#10;        permissionRequested = true&#10;    })&#10;&#10;    // Observe lifecycle to refresh permission when returning from settings or permission dialog&#10;    DisposableEffect(lifecycleOwner) {&#10;        val observer = LifecycleEventObserver { _, event -&gt;&#10;            if (event == Lifecycle.Event.ON_RESUME) {&#10;                val nowGranted = ContextCompat.checkSelfPermission(context, Manifest.permission.CAMERA) == PackageManager.PERMISSION_GRANTED&#10;                hasCameraPermission = nowGranted&#10;            }&#10;        }&#10;        lifecycleOwner.lifecycle.addObserver(observer)&#10;        onDispose { lifecycleOwner.lifecycle.removeObserver(observer) }&#10;    }&#10;&#10;    // auto-launch permission request once when screen appears if not yet granted&#10;    LaunchedEffect(Unit) {&#10;        if (!hasCameraPermission &amp;&amp; !permissionRequested &amp;&amp; !awaitingPermission) {&#10;            awaitingPermission = true&#10;            launcher.launch(Manifest.permission.CAMERA)&#10;        }&#10;    }&#10;&#10;    Surface(modifier = Modifier.fillMaxSize()) {&#10;        Box(modifier = Modifier.fillMaxSize()) {&#10;            if (hasCameraPermission) {&#10;                CameraPreviewForScanner(lifecycleOwner = lifecycleOwner, onQrDetected = { sessionId -&gt;&#10;                    if (!detected) {&#10;                        detected = true&#10;                        Log.d(&quot;ScanQrScreen&quot;, &quot;QR detected: $sessionId&quot;)&#10;                        navController.navigate(&quot;selfie_capture/$sessionId&quot;)&#10;                    }&#10;                })&#10;            } else {&#10;                // If we are awaiting the system permission dialog&#10;                if (awaitingPermission) {&#10;                    Column(modifier = Modifier.fillMaxSize(), horizontalAlignment = Alignment.CenterHorizontally, verticalArrangement = Arrangement.Center) {&#10;                        Text(&quot;Requesting camera permission...&quot;)&#10;                    }&#10;                } else if (!permissionRequested) {&#10;                    // never requested yet (rare because we auto-launch), show prompt UI&#10;                    Column(modifier = Modifier.fillMaxSize(), horizontalAlignment = Alignment.CenterHorizontally, verticalArrangement = Arrangement.Center) {&#10;                        Text(&quot;Camera permission is required to scan QR codes&quot;, color = MaterialTheme.colorScheme.error)&#10;                        Spacer(modifier = Modifier.height(12.dp))&#10;                        Button(onClick = {&#10;                            awaitingPermission = true&#10;                            launcher.launch(Manifest.permission.CAMERA)&#10;                        }) {&#10;                            Text(&quot;Request permission&quot;)&#10;                        }&#10;                    }&#10;                } else {&#10;                    // permission was requested and denied&#10;                    val shouldShowRationale = activity?.let { androidx.core.app.ActivityCompat.shouldShowRequestPermissionRationale(it, Manifest.permission.CAMERA) } ?: false&#10;                    Column(modifier = Modifier.fillMaxSize(), horizontalAlignment = Alignment.CenterHorizontally, verticalArrangement = Arrangement.Center) {&#10;                        Text(&quot;Camera permission is required to scan QR codes&quot;, color = MaterialTheme.colorScheme.error)&#10;                        Spacer(modifier = Modifier.height(12.dp))&#10;&#10;                        // Offer to request permission again&#10;                        Button(onClick = {&#10;                            awaitingPermission = true&#10;                            launcher.launch(Manifest.permission.CAMERA)&#10;                        }) {&#10;                            Text(&quot;Request permission&quot;)&#10;                        }&#10;&#10;                        Spacer(modifier = Modifier.height(8.dp))&#10;&#10;                        // Show settings button only when the user already denied and Android will not show the dialog again&#10;                        if (!shouldShowRationale) {&#10;                            Button(onClick = {&#10;                                val intent = Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS).apply {&#10;                                    data = Uri.fromParts(&quot;package&quot;, context.packageName, null)&#10;                                }&#10;                                context.startActivity(intent)&#10;                            }) {&#10;                                Text(&quot;Open app settings&quot;)&#10;                            }&#10;                        }&#10;                    }&#10;                }&#10;            }&#10;        }&#10;    }&#10;}&#10;&#10;@SuppressLint(&quot;NewApi&quot;)&#10;@ExperimentalGetImage&#10;@Composable&#10;private fun CameraPreviewForScanner(lifecycleOwner: androidx.lifecycle.LifecycleOwner, onQrDetected: (String) -&gt; Unit, lensFacing: Int = CameraSelector.LENS_FACING_BACK) {&#10;    val context = androidx.compose.ui.platform.LocalContext.current&#10;    val previewView = remember { PreviewView(context) }&#10;    val cameraExecutor: ExecutorService = remember { Executors.newSingleThreadExecutor() }&#10;&#10;    // Debounce mechanism to prevent multiple scans&#10;    var lastScanTime by remember { mutableStateOf(0L) }&#10;    val debounceDelay = 2000L // 2 seconds&#10;&#10;    AndroidView(factory = { ctx -&gt;&#10;        val cameraProviderFuture = ProcessCameraProvider.getInstance(ctx)&#10;        cameraProviderFuture.addListener({&#10;            val cameraProvider = cameraProviderFuture.get()&#10;&#10;            val preview = Preview.Builder().build().also { it.setSurfaceProvider(previewView.surfaceProvider) }&#10;&#10;            val selector = CameraSelector.Builder().requireLensFacing(lensFacing).build()&#10;&#10;            // ML Kit barcode scanner&#10;            // Barcode.FORMAT_QR_CODE constant value is 256; using numeric here to avoid unresolved import in analysis environment&#10;            val options = BarcodeScannerOptions.Builder().setBarcodeFormats(256).build()&#10;            val scanner = BarcodeScanning.getClient(options)&#10;&#10;            val analysisUseCase = ImageAnalysis.Builder()&#10;                .setBackpressureStrategy(ImageAnalysis.STRATEGY_KEEP_ONLY_LATEST)&#10;                .build()&#10;&#10;            analysisUseCase.setAnalyzer(cameraExecutor, { imageProxy: ImageProxy -&gt;&#10;                val mediaImage = imageProxy.image&#10;                if (mediaImage != null) {&#10;                    val image = InputImage.fromMediaImage(mediaImage, imageProxy.imageInfo.rotationDegrees)&#10;                    scanner.process(image)&#10;                        .addOnSuccessListener { barcodes -&gt;&#10;                            for (barcode in barcodes) {&#10;                                val raw = barcode.rawValue&#10;                                if (!raw.isNullOrEmpty()) {&#10;                                    // Apply debounce&#10;                                    val now = System.currentTimeMillis()&#10;                                    if (now - lastScanTime &gt; debounceDelay) {&#10;                                        lastScanTime = now&#10;                                        Log.d(&quot;ScanQr&quot;, &quot;QR code detected: $raw&quot;)&#10;                                        onQrDetected(raw)&#10;                                    } else {&#10;                                        Log.d(&quot;ScanQr&quot;, &quot;QR scan debounced, ignoring&quot;)&#10;                                    }&#10;                                    break&#10;                                }&#10;                            }&#10;                        }&#10;                        .addOnFailureListener { e -&gt;&#10;                            Log.e(&quot;ScanQr&quot;, &quot;barcode scan failed&quot;, e)&#10;                        }&#10;                        .addOnCompleteListener {&#10;                            imageProxy.close()&#10;                        }&#10;                } else {&#10;                    imageProxy.close()&#10;                }&#10;            })&#10;&#10;            try {&#10;                cameraProvider.unbindAll()&#10;                cameraProvider.bindToLifecycle(lifecycleOwner, selector, preview, analysisUseCase)&#10;            } catch (exc: Exception) {&#10;                Log.e(&quot;CameraPreview&quot;, &quot;Use case binding failed&quot;, exc)&#10;            }&#10;&#10;        }, ContextCompat.getMainExecutor(ctx))&#10;&#10;        previewView&#10;&#10;    }, modifier = Modifier.fillMaxSize())&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>